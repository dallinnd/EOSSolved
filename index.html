<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EoS Mass Solver (Pro)</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-6">

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">EoS Mass Calculator</h1>
        <p class="text-sm text-gray-500 mb-6">Accurate mass calculation using Cubic Equations of State.</p>

        <div id="status" class="mb-4 text-sm text-blue-600 font-semibold flex items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-4 w-4 mr-2"></div>
            Initializing Python Engine...
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-bold text-blue-800 uppercase mb-3 tracking-wide">1. Problem Variables (System State)</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">System Pressure (P)</label>
                    <div class="flex">
                        <input type="number" id="in_P" value="1" class="w-2/3 p-2 border border-gray-300 rounded-l focus:outline-none focus:border-blue-500">
                        <select id="unit_P" class="w-1/3 p-2 border border-l-0 border-gray-300 rounded-r bg-white text-sm">
                            <option value="101325">atm</option>
                            <option value="100000">bar</option>
                            <option value="6894.76">psi</option>
                            <option value="1">Pa</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">System Temperature (T)</label>
                    <div class="flex">
                        <input type="number" id="in_T" value="25" class="w-2/3 p-2 border border-gray-300 rounded-l focus:outline-none focus:border-blue-500">
                        <select id="unit_T" class="w-1/3 p-2 border border-l-0 border-gray-300 rounded-r bg-white text-sm">
                            <option value="C">°C</option>
                            <option value="K">K</option>
                            <option value="F">°F</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">System Volume (V)</label>
                    <div class="flex">
                        <input type="number" id="in_V" value="1000" class="w-2/3 p-2 border border-gray-300 rounded-l focus:outline-none focus:border-blue-500">
                        <select id="unit_V" class="w-1/3 p-2 border border-l-0 border-gray-300 rounded-r bg-white text-sm">
                            <option value="0.001">Liters</option>
                            <option value="1">m³</option>
                            <option value="0.0283168">ft³</option>
                            <option value="0.00378541">Gallons</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Phase Assumption</label>
                    <select id="phase_pref" class="w-full p-2 border border-gray-300 rounded bg-white">
                        <option value="vapor">Vapor (Gas)</option>
                        <option value="liquid">Liquid</option>
                    </select>
                    <p class="text-[10px] text-gray-500 mt-1 italic">Used if multiple roots exist (VLE region)</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-bold text-gray-700 uppercase mb-3 tracking-wide flex justify-between">
                <span>2. Material Constants</span>
                <span class="text-gray-400 font-normal normal-case text-xs">Defaults: CO2</span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Critical Temp (Tc)</label>
                    <div class="flex">
                        <input type="number" id="in_Tc" value="304.2" class="w-2/3 p-2 border border-gray-300 rounded-l">
                        <select id="unit_Tc" class="w-1/3 p-2 border border-l-0 border-gray-300 rounded-r bg-white text-xs">
                            <option value="K">K</option>
                            <option value="C">°C</option>
                            <option value="F">°F</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Critical Pressure (Pc)</label>
                    <div class="flex">
                        <input type="number" id="in_Pc" value="73.8" class="w-2/3 p-2 border border-gray-300 rounded-l">
                        <select id="unit_Pc" class="w-1/3 p-2 border border-l-0 border-gray-300 rounded-r bg-white text-xs">
                            <option value="100000" selected>bar</option>
                            <option value="101325">atm</option>
                            <option value="6894.76">psi</option>
                            <option value="1">Pa</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Acentric Factor (ω)</label>
                    <input type="number" id="in_w" value="0.224" class="w-full p-2 border border-gray-300 rounded">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Molecular Weight (g/mol)</label>
                    <input type="number" id="in_MW" value="44.01" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
        </div>

        <div class="mb-6 flex flex-wrap gap-4 text-sm text-gray-700 border-t pt-4 justify-center md:justify-start">
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="Pitzer" checked class="form-checkbox text-blue-600"> <span>Pitzer</span></label>
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="SRK" checked class="form-checkbox text-blue-600"> <span>SRK</span></label>
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="PR" checked class="form-checkbox text-blue-600"> <span>Peng-Robinson</span></label>
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="Rackett" checked class="form-checkbox text-blue-600"> <span>Rackett (Liq)</span></label>
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="VdW" class="form-checkbox text-blue-600"> <span>VdW</span></label>
            <label class="inline-flex items-center space-x-2"><input type="checkbox" value="RK" class="form-checkbox text-blue-600"> <span>RK</span></label>
        </div>

        <button onclick="runCalculation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition shadow-md flex justify-center items-center gap-2">
            <span>Run Calculation</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
        </button>

        <div id="results" class="mt-6 overflow-x-auto"></div>
    </div>

    <script type="text/python" id="python-script">
import math

def solve_cubic(c1, c2, c3, phase_pref):
    # Solves Z^3 + c1*Z^2 + c2*Z + c3 = 0
    Q = (3*c2 - c1**2)/9
    R = (9*c1*c2 - 27*c3 - 2*c1**3)/54
    D = Q**3 + R**2
    
    roots = []
    if D > 0:
        S = (R + math.sqrt(D))**(1/3) if (R + math.sqrt(D)) >= 0 else -((- (R + math.sqrt(D)))**(1/3))
        T = (R - math.sqrt(D))**(1/3) if (R - math.sqrt(D)) >= 0 else -((- (R - math.sqrt(D)))**(1/3))
        roots.append(S + T - c1/3)
    else:
        # Three real roots
        theta = math.acos(R/math.sqrt(-(Q**3)))
        roots.append(2*math.sqrt(-Q)*math.cos(theta/3) - c1/3)
        roots.append(2*math.sqrt(-Q)*math.cos((theta + 2*math.pi)/3) - c1/3)
        roots.append(2*math.sqrt(-Q)*math.cos((theta + 4*math.pi)/3) - c1/3)
    
    # Filter physical roots Z > 0
    valid = [r for r in roots if r > 0.001]
    if not valid: return 1.0
    
    # Phase Logic
    if len(valid) == 1:
        return valid[0]
    else:
        # VLE Region: Multiple roots
        if phase_pref == 'liquid':
            return min(valid) # Smallest root = liquid Z
        else:
            return max(valid) # Largest root = vapor Z

def calculate(models_str, P, T, V, Tc, Pc, w, MW, R, phase_pref):
    models = models_str.split(',')
    results = []
    Tr = T/Tc
    Pr = P/Pc
    
    for model in models:
        try:
            Z = 1.0
            
            # --- Pitzer (Virial) ---
            if model == "Pitzer":
                B0 = 0.083 - 0.422/(Tr**1.6)
                B1 = 0.139 - 0.172/(Tr**4.2)
                Z = 1 + (B0 + w*B1)*(Pr/Tr)
            
            # --- Cubics ---
            elif model in ["VdW", "RK", "SRK", "PR"]:
                if model == "VdW":
                    A = (27/64)*(Pr/Tr**2); B = (1/8)*(Pr/Tr)
                    c1, c2, c3 = -(1+B), A, -A*B
                elif model == "RK":
                    A = 0.42748 * (Tr**-0.5) * Pr/(Tr**2)
                    B = 0.08664 * Pr/Tr
                    c1, c2, c3 = -1, A-B-B**2, -A*B
                elif model == "SRK":
                    m = 0.480 + 1.574*w - 0.176*w**2
                    alpha = (1 + m*(1-math.sqrt(Tr)))**2
                    A = 0.42748 * alpha * Pr/(Tr**2)
                    B = 0.08664 * Pr/Tr
                    c1, c2, c3 = -1, A-B-B**2, -A*B
                elif model == "PR":
                    m = 0.37464 + 1.54226*w - 0.26992*w**2
                    alpha = (1 + m*(1-math.sqrt(Tr)))**2
                    A = 0.45724 * alpha * Pr/(Tr**2)
                    B = 0.07780 * Pr/Tr
                    c1, c2, c3 = B-1, A-3*B**2-2*B, B**3+B**2-A*B
                
                Z = solve_cubic(c1, c2, c3, phase_pref)
            
            # --- Rackett (Liquid Only) ---
            elif model == "Rackett":
                if Tr > 1.0:
                    results.append([model, "N/A", "Gas (T>Tc)"])
                    continue
                Z_ra = 0.29056 - 0.08775*w
                Vc = (R*Tc*Z_ra)/Pc
                v_liq = Vc * (Z_ra**((1-Tr)**(2/7)))
                n = V/v_liq
                mass = n * (MW/1000)
                Z_eff = (P*v_liq)/(R*T)
                results.append([model, f"{Z_eff:.4f}", f"{mass:.4f}"])
                continue
            
            # --- Mass Calculation for Gas/Cubic ---
            v = (Z*R*T)/P
            n = V/v
            mass = n * (MW/1000)
            results.append([model, f"{Z:.4f}", f"{mass:.4f}"])
            
        except Exception as e:
            results.append([model, "Error", str(e)])
            
    return results
    </script>

    <script>
        let pyodide;
        async function main() {
            try {
                pyodide = await loadPyodide();
                document.getElementById("status").innerHTML = '<span class="text-green-600 flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> System Ready</span>';
                await pyodide.runPythonAsync(document.getElementById("python-script").textContent);
            } catch (err) {
                document.getElementById("status").innerText = "Err: " + err;
            }
        }
        main();

        async function runCalculation() {
            if (!pyodide) return;

            // --- 1. System Variables (Convert to SI) ---
            let P_raw = parseFloat(document.getElementById('in_P').value);
            let P_si = P_raw * parseFloat(document.getElementById('unit_P').value);

            let T_raw = parseFloat(document.getElementById('in_T').value);
            let T_unit = document.getElementById('unit_T').value;
            let T_si = T_raw;
            if (T_unit === 'C') T_si = T_raw + 273.15;
            if (T_unit === 'F') T_si = (T_raw - 32) * 5/9 + 273.15;

            let V_raw = parseFloat(document.getElementById('in_V').value);
            let V_si = V_raw * parseFloat(document.getElementById('unit_V').value);
            
            let phase = document.getElementById('phase_pref').value;

            // --- 2. Material Constants (Convert to SI) ---
            let Tc_raw = parseFloat(document.getElementById('in_Tc').value);
            let Tc_unit = document.getElementById('unit_Tc').value;
            let Tc_si = Tc_raw;
            if (Tc_unit === 'C') Tc_si = Tc_raw + 273.15;
            if (Tc_unit === 'F') Tc_si = (Tc_raw - 32) * 5/9 + 273.15;

            let Pc_raw = parseFloat(document.getElementById('in_Pc').value);
            let Pc_si = Pc_raw * parseFloat(document.getElementById('unit_Pc').value);

            let w = parseFloat(document.getElementById('in_w').value);
            let MW = parseFloat(document.getElementById('in_MW').value);
            let R = 8.314;

            // --- 3. Execute ---
            const checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
            const models = Array.from(checkboxes).map(cb => cb.value).join(',');
            
            console.log(`System: P=${P_si} Pa, T=${T_si} K, V=${V_si} m3 | Fluid: Tc=${Tc_si} K, Pc=${Pc_si} Pa`);

            const cmd = `calculate('${models}', ${P_si}, ${T_si}, ${V_si}, ${Tc_si}, ${Pc_si}, ${w}, ${MW}, ${R}, '${phase}')`;
            const result = (await pyodide.runPythonAsync(cmd)).toJs();

            // --- 4. Render ---
            let html = `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-xs text-blue-900 rounded-r shadow-sm">
                <strong>Calculation Basis (SI):</strong> P = ${P_si.toFixed(0)} Pa, T = ${T_si.toFixed(2)} K, Tc = ${Tc_si.toFixed(2)} K
            </div>
            <table class="min-w-full divide-y divide-gray-200 border text-sm rounded-lg overflow-hidden">
                <thead class="bg-gray-100"><tr>
                    <th class="px-4 py-3 text-left text-gray-600 uppercase font-bold text-xs">Model</th>
                    <th class="px-4 py-3 text-left text-gray-600 uppercase font-bold text-xs">Z Factor</th>
                    <th class="px-4 py-3 text-left text-gray-600 uppercase font-bold text-xs">Mass (kg)</th>
                </tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            result.forEach(row => {
                html += `<tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 font-medium text-gray-900">${row[0]}</td>
                    <td class="px-4 py-3 text-gray-500 font-mono">${row[1]}</td>
                    <td class="px-4 py-3 font-bold text-blue-600 font-mono">${row[2]}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
