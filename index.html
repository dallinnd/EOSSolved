<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EoS Mass Solver</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">EoS Mass Calculator</h1>
        <p class="text-sm text-gray-500 mb-6">Solves for Mass (kg) and Compressibility (Z)</p>

        <div id="status" class="mb-4 text-sm text-blue-600 font-semibold flex items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-4 w-4 mr-2"></div>
            Loading Python Engine...
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">Select Models:</label>
            <div class="grid grid-cols-2 gap-2">
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="Pitzer" checked> <span class="ml-2">Pitzer</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="VdW" checked> <span class="ml-2">van der Waals</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="RK" checked> <span class="ml-2">Redlich-Kwong</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="SRK" checked> <span class="ml-2">SRK</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="PR" checked> <span class="ml-2">Peng-Robinson</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="Lee-Kesler"> <span class="ml-2">Lee-Kesler (Proxy)</span></label>
                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox" value="Rackett"> <span class="ml-2">Rackett (Liquid)</span></label>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div><label class="block text-xs font-bold text-gray-700">Pressure (Pa)</label><input type="number" id="in_P" value="101325" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">Temperature (K)</label><input type="number" id="in_T" value="298.15" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">Volume (m³)</label><input type="number" id="in_V" value="1.0" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">Critical Temp (K)</label><input type="number" id="in_Tc" value="304.2" class="w-full p-2 border rounded"></div> <div><label class="block text-xs font-bold text-gray-700">Critical Press (Pa)</label><input type="number" id="in_Pc" value="7380000" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">Omega (ω)</label><input type="number" id="in_w" value="0.224" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">MW (g/mol)</label><input type="number" id="in_MW" value="44.01" class="w-full p-2 border rounded"></div>
            <div><label class="block text-xs font-bold text-gray-700">R (J/mol·K)</label><input type="number" id="in_R" value="8.314" class="w-full p-2 border rounded"></div>
        </div>

        <button onclick="runCalculation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition">
            Run Calculation
        </button>

        <div id="results" class="mt-6"></div>
    </div>

    <script type="text/python" id="python-script">
import math

def solve_cubic(c1, c2, c3):
    # Solves Z^3 + c1*Z^2 + c2*Z + c3 = 0
    # Standard Cardano approach for largest real root
    Q = (3*c2 - c1**2)/9
    R = (9*c1*c2 - 27*c3 - 2*c1**3)/54
    D = Q**3 + R**2
    
    roots = []
    if D > 0:
        S = (R + math.sqrt(D))**(1/3) if (R + math.sqrt(D)) >= 0 else -((- (R + math.sqrt(D)))**(1/3))
        T = (R - math.sqrt(D))**(1/3) if (R - math.sqrt(D)) >= 0 else -((- (R - math.sqrt(D)))**(1/3))
        roots.append(S + T - c1/3)
    else:
        theta = math.acos(R/math.sqrt(-(Q**3)))
        roots.append(2*math.sqrt(-Q)*math.cos(theta/3) - c1/3)
        roots.append(2*math.sqrt(-Q)*math.cos((theta + 2*math.pi)/3) - c1/3)
        roots.append(2*math.sqrt(-Q)*math.cos((theta + 4*math.pi)/3) - c1/3)
    
    # Filter physical roots (Z > 0)
    valid = [r for r in roots if r > 0]
    if not valid: return 1.0
    return max(valid) # Default to Vapor root

def calculate(models_str, P, T, V, Tc, Pc, w, MW, R):
    models = models_str.split(',')
    results = []
    
    Tr = T/Tc
    Pr = P/Pc
    
    for model in models:
        try:
            Z = 1.0
            phase_note = ""
            
            if model == "Pitzer":
                B0 = 0.083 - 0.422/(Tr**1.6)
                B1 = 0.139 - 0.172/(Tr**4.2)
                Z = 1 + (B0 + w*B1)*(Pr/Tr)
                
            elif model in ["VdW", "RK", "SRK", "PR", "Lee-Kesler"]:
                # Using SRK logic for Lee-Kesler proxy in this demo
                eff_model = "SRK" if model == "Lee-Kesler" else model
                
                # Parameters
                if eff_model == "VdW":
                    A = (27/64)*(Pr/Tr**2); B = (1/8)*(Pr/Tr)
                    c1, c2, c3 = -(1+B), A, -A*B
                elif eff_model == "RK":
                    A = 0.42748 * (Tr**-0.5) * Pr/(Tr**2)
                    B = 0.08664 * Pr/Tr
                    c1, c2, c3 = -1, A-B-B**2, -A*B
                elif eff_model == "SRK":
                    m = 0.480 + 1.574*w - 0.176*w**2
                    alpha = (1 + m*(1-math.sqrt(Tr)))**2
                    A = 0.42748 * alpha * Pr/(Tr**2)
                    B = 0.08664 * Pr/Tr
                    c1, c2, c3 = -1, A-B-B**2, -A*B
                elif eff_model == "PR":
                    m = 0.37464 + 1.54226*w - 0.26992*w**2
                    alpha = (1 + m*(1-math.sqrt(Tr)))**2
                    A = 0.45724 * alpha * Pr/(Tr**2)
                    B = 0.07780 * Pr/Tr
                    c1, c2, c3 = B-1, A-3*B**2-2*B, B**3+B**2-A*B
                
                Z = solve_cubic(c1, c2, c3)
                
            elif model == "Rackett":
                if Tr > 1.0:
                    results.append([model, "N/A (T>Tc)", "N/A"])
                    continue
                Z_ra = 0.29056 - 0.08775*w
                Vc = (R*Tc*Z_ra)/Pc
                v_liq = Vc * (Z_ra**((1-Tr)**(2/7)))
                n = V/v_liq
                mass = n * (MW/1000)
                Z_eff = (P*v_liq)/(R*T)
                results.append([model, round(Z_eff, 4), round(mass, 4)])
                continue
            
            # General Gas Mass Calc
            v = (Z*R*T)/P
            n = V/v
            mass = n * (MW/1000)
            results.append([model, round(Z, 4), round(mass, 4)])
            
        except Exception as e:
            results.append([model, "Error", str(e)])
            
    return results
    </script>

    <script>
        let pyodide;

        async function main() {
            pyodide = await loadPyodide();
            document.getElementById("status").innerHTML = '<span class="text-green-600">✔ System Ready</span>';
            // Load the python script content
            const pythonCode = document.getElementById("python-script").textContent;
            await pyodide.runPythonAsync(pythonCode);
        }
        main();

        async function runCalculation() {
            if (!pyodide) return;

            // Get Inputs
            const inputs = {
                P: parseFloat(document.getElementById('in_P').value),
                T: parseFloat(document.getElementById('in_T').value),
                V: parseFloat(document.getElementById('in_V').value),
                Tc: parseFloat(document.getElementById('in_Tc').value),
                Pc: parseFloat(document.getElementById('in_Pc').value),
                w: parseFloat(document.getElementById('in_w').value),
                MW: parseFloat(document.getElementById('in_MW').value),
                R: parseFloat(document.getElementById('in_R').value)
            };

            // Get Selected Models
            const checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
            const models = Array.from(checkboxes).map(cb => cb.value).join(',');

            // Call Python Function
            // Note: We pass arguments strictly
            const cmd = `calculate('${models}', ${inputs.P}, ${inputs.T}, ${inputs.V}, ${inputs.Tc}, ${inputs.Pc}, ${inputs.w}, ${inputs.MW}, ${inputs.R})`;
            const resultProxy = await pyodide.runPythonAsync(cmd);
            const result = resultProxy.toJs(); // Convert PyProxy to JS Array

            // Render Table
            let html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comp. Factor (Z)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mass (kg)</th>
                </tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            result.forEach(row => {
                html += `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row[0]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row[1]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${row[2]}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('results').innerHTML = html;
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
