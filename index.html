<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generic Cubic EoS Solver</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-tab { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .inactive-tab { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-6">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden flex flex-col min-h-[600px]">
        
        <div class="bg-white border-b px-6 pt-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Cubic EoS Solver</h1>
            <p class="text-sm text-gray-500 mb-4">Generic Cubic Form: $Z = 1 + \beta - q\beta \frac{Z-\beta}{(Z+\epsilon\beta)(Z+\sigma\beta)}$</p>
            
            <div class="flex space-x-6 text-sm">
                <button id="tab_mass" onclick="switchTab('mass')" class="active-tab pb-3 focus:outline-none">
                    Solve for Mass (kg)
                </button>
                <button id="tab_vol" onclick="switchTab('volume')" class="inactive-tab pb-3 hover:text-gray-800 focus:outline-none">
                    Solve for Volume (m³)
                </button>
            </div>
        </div>

        <div id="status" class="bg-blue-50 px-6 py-2 text-xs text-blue-600 font-semibold flex items-center border-b">
            <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-300 h-3 w-3 mr-2"></div>
            Loading Python Engine...
        </div>

        <div class="p-6 flex-grow overflow-y-auto">
            
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">1. State Variables</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Pressure (P)</label>
                    <div class="flex">
                        <input type="number" id="in_P" value="1" class="w-2/3 p-2 border rounded-l">
                        <select id="unit_P" class="w-1/3 p-2 border border-l-0 rounded-r bg-white text-xs">
                            <option value="101325">atm</option>
                            <option value="100000">bar</option>
                            <option value="6894.76">psi</option>
                            <option value="1">Pa</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Temperature (T)</label>
                    <div class="flex">
                        <input type="number" id="in_T" value="25" class="w-2/3 p-2 border rounded-l">
                        <select id="unit_T" class="w-1/3 p-2 border border-l-0 rounded-r bg-white text-xs">
                            <option value="C">°C</option>
                            <option value="K">K</option>
                            <option value="F">°F</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded border border-blue-200 mb-6">
                <label id="lbl_dynamic" class="block text-xs font-bold text-blue-800 mb-1 uppercase">Total Volume (V)</label>
                <div class="flex">
                    <input type="number" id="in_dynamic" value="1000" class="w-2/3 p-2 border border-blue-300 rounded-l focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="unit_dynamic" class="w-1/3 p-2 border border-l-0 border-blue-300 rounded-r bg-white text-xs">
                        </select>
                </div>
                <div class="mt-2 text-xs text-blue-600">
                    <label class="inline-flex items-center">
                        <span class="mr-2 font-bold">Phase Preference:</span>
                        <select id="phase_pref" class="p-1 border rounded bg-white text-xs">
                            <option value="vapor">Vapor (Gas)</option>
                            <option value="liquid">Liquid</option>
                        </select>
                    </label>
                </div>
            </div>

            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex justify-between">
                <span>2. Fluid Constants</span>
                <span class="font-normal normal-case">Default: CO2</span>
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 bg-gray-50 p-3 rounded border">
                <div>
                    <label class="block text-[10px] text-gray-500">Tc (K)</label>
                    <input type="number" id="in_Tc" value="304.2" class="w-full p-1 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">Pc (bar)</label>
                    <input type="number" id="in_Pc" value="73.8" class="w-full p-1 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">Omega (ω)</label>
                    <input type="number" id="in_w" value="0.224" class="w-full p-1 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">MW (g/mol)</label>
                    <input type="number" id="in_MW" value="44.01" class="w-full p-1 border rounded text-sm">
                </div>
            </div>

            <button onclick="runCalculation()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3 px-4 rounded transition shadow-lg flex justify-center items-center gap-2">
                <span id="btn_text">Solve for Mass</span>
            </button>

            <div id="results" class="mt-8"></div>
        </div>
    </div>

    <script>
        let currentMode = 'mass'; // 'mass' or 'volume'

        const unitsVolume = `
            <option value="0.001">Liters</option>
            <option value="1">m³</option>
            <option value="0.0283168">ft³</option>
            <option value="0.00378541">Gallons</option>
        `;
        const unitsMass = `
            <option value="1">kg</option>
            <option value="0.001">grams</option>
            <option value="0.453592">lbs</option>
        `;

        // Init
        document.getElementById('unit_dynamic').innerHTML = unitsVolume;

        function switchTab(mode) {
            currentMode = mode;
            const btnMass = document.getElementById('tab_mass');
            const btnVol = document.getElementById('tab_vol');
            const lblDyn = document.getElementById('lbl_dynamic');
            const inpDyn = document.getElementById('in_dynamic');
            const selDyn = document.getElementById('unit_dynamic');
            const btnAct = document.getElementById('btn_text');

            if (mode === 'mass') {
                btnMass.className = "active-tab pb-3 focus:outline-none";
                btnVol.className = "inactive-tab pb-3 hover:text-gray-800 focus:outline-none";
                lblDyn.innerText = "TOTAL VOLUME (V)";
                inpDyn.value = "1000";
                selDyn.innerHTML = unitsVolume;
                btnAct.innerText = "Solve for Mass";
            } else {
                btnVol.className = "active-tab pb-3 focus:outline-none";
                btnMass.className = "inactive-tab pb-3 hover:text-gray-800 focus:outline-none";
                lblDyn.innerText = "TOTAL MASS (m)";
                inpDyn.value = "10";
                selDyn.innerHTML = unitsMass;
                btnAct.innerText = "Solve for Volume";
            }
            // Clear results on switch
            document.getElementById('results').innerHTML = '';
        }
    </script>

    <script type="text/python" id="python-script">
import math

def solve_generic_cubic(beta, q, epsilon, sigma, phase_pref):
    # Solves: Z = 1 + beta - q*beta * (Z - beta) / ((Z + epsilon*beta)*(Z + sigma*beta))
    # Rearranges to: Z^3 + c1*Z^2 + c2*Z + c3 = 0
    
    # Derivation of coefficients:
    # Eq: (Z - (1+beta)) * (Z^2 + (eps+sig)*beta*Z + eps*sig*beta^2) + q*beta*(Z - beta) = 0
    
    term_es = epsilon + sigma
    term_es_prod = epsilon * sigma
    
    # Coefficients for Z^3 + c1*Z^2 + c2*Z + c3 = 0
    c1 = term_es*beta - (1 + beta)
    
    # c2 term breakdown:
    # From expansion: eps*sig*beta^2 - (1+beta)(eps+sig)*beta + q*beta
    c2 = term_es_prod*(beta**2) - (1 + beta)*term_es*beta + q*beta
    
    # c3 term breakdown:
    # From expansion: -(1+beta)*eps*sig*beta^2 - q*beta^2
    c3 = -(1 + beta)*term_es_prod*(beta**2) - q*(beta**2)
    
    # --- CARDANO SOLVER ---
    Q_val = (3*c2 - c1**2)/9
    R_val = (9*c1*c2 - 27*c3 - 2*c1**3)/54
    D_val = Q_val**3 + R_val**2
    
    roots = []
    if D_val > 0:
        # One real root
        S = (R_val + math.sqrt(D_val))**(1/3) if (R_val + math.sqrt(D_val)) >= 0 else -((- (R_val + math.sqrt(D_val)))**(1/3))
        T = (R_val - math.sqrt(D_val))**(1/3) if (R_val - math.sqrt(D_val)) >= 0 else -((- (R_val - math.sqrt(D_val)))**(1/3))
        roots.append(S + T - c1/3)
    else:
        # Three real roots
        theta = math.acos(R_val/math.sqrt(-(Q_val**3)))
        roots.append(2*math.sqrt(-Q_val)*math.cos(theta/3) - c1/3)
        roots.append(2*math.sqrt(-Q_val)*math.cos((theta + 2*math.pi)/3) - c1/3)
        roots.append(2*math.sqrt(-Q_val)*math.cos((theta + 4*math.pi)/3) - c1/3)
    
    # Filter Physical Roots (Z > beta) usually required for log terms in fugacity, 
    # but strictly Z > 0 is the basic physical requirement.
    valid = [r for r in roots if r > 0.001] 
    
    if not valid: return 1.0 # Fail safe
    
    if len(valid) == 1:
        return valid[0]
    
    # VLE Logic
    if phase_pref == 'liquid':
        return min(valid)
    else:
        return max(valid)

def calculate(mode, P, T, InputVal, Tc, Pc, w, MW):
    # InputVal is Volume(m3) if mode='mass', Mass(kg) if mode='volume'
    
    R = 8.314
    Tr = T / Tc
    Pr = P / Pc
    
    results = []
    
    # Define Models with User's Exact Constants
    # [Name, sigma, epsilon, Omega, Psi, Zc_check]
    models_data = [
        ("VdW", 0, 0, 1/8, 27/64),
        ("RK", 1, 0, 0.08664, 0.42748),
        ("SRK", 1, 0, 0.08664, 0.42748),
        ("PR", 1 + math.sqrt(2), 1 - math.sqrt(2), 0.07780, 0.45724)
    ]
    
    for name, sigma, epsilon, omega_eos, psi in models_data:
        try:
            # 1. Calculate Alpha
            alpha = 1.0
            if name == "VdW":
                alpha = 1.0
            elif name == "RK":
                alpha = Tr**(-0.5)
            elif name == "SRK":
                m = 0.480 + 1.574*w - 0.176*w**2
                alpha = (1 + m*(1 - math.sqrt(Tr)))**2
            elif name == "PR":
                m = 0.37464 + 1.54226*w - 0.26992*w**2
                alpha = (1 + m*(1 - math.sqrt(Tr)))**2
            
            # 2. Calculate Beta and q
            # User: beta = omega * Pr / Tr
            beta = omega_eos * (Pr / Tr)
            
            # User: q = psi * alpha / (omega * Tr)
            q = (psi * alpha) / (omega_eos * Tr)
            
            # 3. Solve Cubic
            # Need phase pref passed from JS? We'll grab from args or default vapor
            # For simplicity, we assume vapor unless specified, but let's grab it later.
            # We will return the 'Z' found.
            
            # Hack: We need phase_pref. Let's assume passed in kwargs or global?
            # Actually, let's just compute both roots if needed, but for now we rely on strict 'solve_generic_cubic' logic
            # We will use a global var set by JS or pass it. 
            # *Correction*: I will fetch phase_pref inside the loop (passed as arg in next version).
            # For now, let's assume the helper function `solve_generic_cubic` is self-contained.
            pass 
        except:
            pass
    
    return []

# --- MAIN WRAPPER ---
def run_analysis(mode, P, T, InputVal, Tc, Pc, w, MW, phase_pref):
    R = 8.314
    Tr = T / Tc
    Pr = P / Pc
    
    output = []
    
    # List of models
    models = [
        {"name": "VdW", "sig": 0, "eps": 0, "Om": 1/8, "Psi": 27/64},
        {"name": "RK", "sig": 1, "eps": 0, "Om": 0.08664, "Psi": 0.42748},
        {"name": "SRK", "sig": 1, "eps": 0, "Om": 0.08664, "Psi": 0.42748},
        {"name": "PR", "sig": 1+math.sqrt(2), "eps": 1-math.sqrt(2), "Om": 0.07780, "Psi": 0.45724}
    ]
    
    for m in models:
        try:
            # Alpha
            alpha = 1.0
            if m["name"] == "RK": alpha = Tr**-0.5
            if m["name"] == "SRK":
                k = 0.480 + 1.574*w - 0.176*w**2
                alpha = (1 + k*(1 - math.sqrt(Tr)))**2
            if m["name"] == "PR":
                k = 0.37464 + 1.54226*w - 0.26992*w**2
                alpha = (1 + k*(1 - math.sqrt(Tr)))**2
                
            # Beta / q
            beta = m["Om"] * Pr / Tr
            q = (m["Psi"] * alpha) / (m["Om"] * Tr)
            
            # Solve Z
            Z = solve_generic_cubic(beta, q, m["eps"], m["sig"], phase_pref)
            
            # Calculate Result
            v_molar = (Z * R * T) / P
            
            if mode == 'mass':
                # InputVal is Total Volume
                n = InputVal / v_molar
                res_val = n * (MW / 1000.0) # Mass in kg
            else:
                # InputVal is Total Mass (kg)
                n = InputVal / (MW / 1000.0)
                res_val = n * v_molar # Volume in m3
                
            output.append([m["name"], f"{Z:.4f}", f"{res_val:.4f}"])
            
        except Exception as e:
            output.append([m["name"], "Error", "Calc Fail"])

    return output
    </script>

    <script>
        let pyodide;
        async function main() {
            try {
                pyodide = await loadPyodide();
                document.getElementById("status").innerHTML = '<span class="text-green-600">✔ Engine Ready</span>';
                await pyodide.runPythonAsync(document.getElementById("python-script").textContent);
            } catch (err) {
                document.getElementById("status").innerText = "Err: " + err;
            }
        }
        main();

        async function runCalculation() {
            if (!pyodide) return;

            // 1. Inputs (SI Conversion)
            let P = parseFloat(document.getElementById('in_P').value) * parseFloat(document.getElementById('unit_P').value);
            
            let T_raw = parseFloat(document.getElementById('in_T').value);
            let T_unit = document.getElementById('unit_T').value;
            let T = (T_unit === 'C') ? T_raw + 273.15 : (T_unit === 'F') ? (T_raw - 32)*5/9 + 273.15 : T_raw;
            
            // Dynamic Input
            let Dyn_raw = parseFloat(document.getElementById('in_dynamic').value);
            let Dyn_fac = parseFloat(document.getElementById('unit_dynamic').value);
            let InputVal = Dyn_raw * Dyn_fac; // Either m3 or kg

            // Constants
            let Tc = parseFloat(document.getElementById('in_Tc').value); // Assume K
            let Pc = parseFloat(document.getElementById('in_Pc').value) * 100000; // bar input -> Pa
            let w = parseFloat(document.getElementById('in_w').value);
            let MW = parseFloat(document.getElementById('in_MW').value);
            let phase = document.getElementById('phase_pref').value;

            // 2. Run Python
            // run_analysis(mode, P, T, InputVal, Tc, Pc, w, MW, phase_pref)
            let cmd = `run_analysis('${currentMode}', ${P}, ${T}, ${InputVal}, ${Tc}, ${Pc}, ${w}, ${MW}, '${phase}')`;
            let result = (await pyodide.runPythonAsync(cmd)).toJs();

            // 3. Render
            let col3_header = (currentMode === 'mass') ? "Calculated Mass (kg)" : "Calculated Volume (m³)";
            
            let html = `
            <table class="min-w-full divide-y divide-gray-200 border text-sm">
                <thead class="bg-gray-100"><tr>
                    <th class="px-4 py-2 text-left font-bold text-gray-700">Model</th>
                    <th class="px-4 py-2 text-left font-bold text-gray-700">Z Factor</th>
                    <th class="px-4 py-2 text-left font-bold text-gray-700">${col3_header}</th>
                </tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            result.forEach(row => {
                html += `<tr>
                    <td class="px-4 py-2 font-medium">${row[0]}</td>
                    <td class="px-4 py-2 text-gray-500 font-mono">${row[1]}</td>
                    <td class="px-4 py-2 font-bold text-blue-600 font-mono">${row[2]}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            
            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
